# All jobs should run successfully in an environment setup by the
# scripts/ci/setup/build-environment.yml task:
# "Install basic packages to build QEMU on Ubuntu/Debian"

.debian_ppc64le_template:
  extends: .custom_runner_template
  needs: []
  stage: build
  tags:
    - debian_13
    - ppc64le
  rules:
    - if: '$CI_PROJECT_NAMESPACE == $QEMU_CI_UPSTREAM && $CI_COMMIT_BRANCH =~ /^staging/'
    - if: '$QEMU_CI != "1" && $QEMU_CI != "2" && $CI_PROJECT_NAMESPACE != $QEMU_CI_UPSTREAM'
      when: never
    - if: '$PPC64LE_RUNNER_AVAILABLE && $CI_PIPELINE_SOURCE != "schedule" && $QEMU_CI == "1"'
      when: manual
    - if: '$PPC64LE_RUNNER_AVAILABLE && $CI_PIPELINE_SOURCE != "schedule"'
  before_script:
    - source scripts/ci/gitlab-ci-section
    - section_start setup "Pre-script setup"
    - JOBS=$(expr $(nproc) - 2)
    - section_end setup
  script:
    - mkdir build
    - cd build
    - section_start configure "Running configure"
    - ../configure $CONFIGURE_ARGS ||
          { cat config.log meson-logs/meson-log.txt && exit 1; }
    - section_end configure
    - section_start build "Building QEMU"
    - make --output-sync -j"$JOBS"
    - section_end build
    - section_start test "Running tests"
    - if test -n "$MAKE_CHECK_ARGS";
      then
        make -j"$JOBS" $MAKE_CHECK_ARGS ;
      fi
    - section_end test

debian-13-ppc64le-default:
  extends: .debian_ppc64le_template
  variables:
    # qtest currently fails: https://gitlab.com/qemu-project/qemu/-/issues/3207
    MAKE_CHECK_ARGS: check-unit check-tcg check-softfloat
